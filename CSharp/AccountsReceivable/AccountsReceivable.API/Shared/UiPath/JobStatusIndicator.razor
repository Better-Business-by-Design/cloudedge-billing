@using System.Timers
@using AccountsReceivable.BL.Models.Json
@using AccountsReceivable.BL.Models.Json.Enum
@inject UiPathClient UiPathClient

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">@Job?.ReleaseName</MudText>
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudAlert Severity="@(_status?.State.Severity() ?? Severity.Info)" Class="flex-grow-0">Job state: @_status?.State</MudAlert>
        <MudText Typo="Typo.body1">Runtime: @_jobLength?.ToString(@"hh\:mm\:ss")</MudText>
    </MudCardContent>
    <MudCardActions>
        @if (!_status?.State.Completed() ?? false)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
        }
    </MudCardActions>
</MudCard>



@code {
    [Parameter]
    public UiPathJobDto? Job { get; set; }
    
    private Timer _timer;
    private UiPathJobStatusDto? _status;
    private TimeSpan? _jobLength;
    private Severity _severity;

    [Parameter]
    public double Interval { get; set; } = 1000;

    protected override void OnInitialized()
    {
        _timer = new Timer(Interval);
        _timer.Elapsed += async (s, e) =>
        {
            await InvokeAsync(GetProcessStatus);
        };
        _timer.Enabled = true;

    }

    private async Task GetProcessStatus()
    {
        if (Job is not null)
        {
            _status = await UiPathClient.GetProcessStatus(Job.ReleaseName);
            var endTime = _status.EndTime ?? TimeZoneInfo.ConvertTime(DateTime.Now, TimeZoneInfo.FindSystemTimeZoneById("GMT Standard Time"));
            var startTime = _status.StartTime;

            if (startTime is not null)
            {
                _jobLength = endTime - startTime;
            }
            if (_status.State.Completed())
            {
                _timer.Enabled = false;
            }
            StateHasChanged();
        }
    }

}